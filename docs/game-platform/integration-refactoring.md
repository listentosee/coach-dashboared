## Game Platform Integration Refactoring Plan

### Goals
- Decouple MetaCTF-specific data from core domain tables (`profiles`, `competitors`, `teams`).
- Provide a uniform store for all MetaCTF user and team records with lifecycle metadata (status, sync timestamps, errors).
- Improve resilience for onboarding flows by isolating third-party state while keeping local data authoritative.

### Current Status
- **Completed**
  - New `game_platform_profiles` / `game_platform_teams` tables plus enums and migrations.
  - Repository layer (`lib/integrations/game-platform/repository.ts`) and service refactor to use it.
  - Updated coach/competitor onboarding flows and team member sync paths to write through the new tables.
  - Backfill SQL drafted for coaches, competitors, and teams.
  - Route updates for dashboard, report card, competitor create, team member add, internal sync, and admin context.
  - Playwright coverage (`game-platform-routes` project) verifying the touched endpoints and auth guards.
- **In Progress**
  - Running migrations and backfill in staging (pending deployment window).
  - Verifying RLS policies once staging data is migrated.
- **Outstanding**
  - Harden SECURITY DEFINER functions (search_path) and rerun Supabase lint.
  - Drop legacy `game_platform_*` columns after stability window.
  - Optional `game_platform_sync_events` table (if still desired).
  - Documentation updates for ongoing ops/runbook and rollback steps.

### Proposed Schema Changes

1. **New Table: `game_platform_profiles`**
   - `id` (uuid, PK, autogenerated)
   - `coach_id` (uuid, FK → `profiles.id`, nullable)
   - `competitor_id` (uuid, FK → `competitors.id`, nullable)
   - Constraint: exactly one of `coach_id` / `competitor_id` must be non-null
   - `metactf_role` (enum: `coach`, `user`) — separate from the existing `profiles.role` values (`coach`, `admin`) so the MetaCTF-facing role map can represent non-coach competitors without affecting core auth logic.
   - `synced_user_id` (text) – MetaCTF UUID
   - `metactf_user_id` (integer) – Numeric MetaCTF ID
   - `metactf_username` (text)
   - `status` (enum: `pending`, `user_created`, `approved`, `denied`, `error`)
   - `last_synced_at` (timestamptz)
   - `sync_error` (text)
   - `created_at` / `updated_at` (timestamptz defaults)
   - Unique indexes on `coach_id`, `competitor_id`, and `synced_user_id`

2. **New Table: `game_platform_teams`**
   - `id` (uuid, PK)
   - `team_id` (uuid, FK → `teams.id`, unique)
   - `synced_team_id` (text)
   - `metactf_team_id` (integer)
   - `metactf_team_name` (text)
   - `status` (enum: `pending`, `user_created`, `approved`, `error`)
   - `last_synced_at` (timestamptz)
   - `sync_error` (text)
   - `created_at` / `updated_at`
   - Optional: `coach_profile_id` FK → `game_platform_profiles.id` for easy joins

3. **Optional Table: `game_platform_sync_events`** (audit trail)
   - References `game_platform_profiles.id` or `game_platform_teams.id`
   - Stores sync attempt metadata (request type, payload hash, response, result)

4. **Adjustments to `teams` / `team_members`**
   - Replace inline `game_platform_*` columns with joins to `game_platform_profiles` (coach members) and `game_platform_teams` (team linkage).

4. **Migration Strategy**
   - Create new tables with RLS/foreign keys.
   - Backfill existing pre-prod data (if any) by reading current `game_platform_*` columns.
   - Deploy code updates that read/write via the new tables.
   - Recreate existing SECURITY DEFINER functions/triggers with `SET search_path = ''` and fully qualified references to clear Supabase lint 0011.
   - Drop obsolete columns once stability confirmed.

### Code Refactor Steps

1. **Data Access Layer**
   - Introduce helper module (e.g., `lib/integrations/game-platform/repository.ts`) to encapsulate CRUD operations on `game_platform_profiles`.
   - Update `ensureCoachGamePlatformId`, competitor onboarding, and sync jobs to use the repository rather than mutating `profiles` directly.

2. **Onboarding Flow**
   - When onboarding a coach or competitor:
     - Create/update entry in `game_platform_profiles`.
     - Persist MetaCTF status, IDs, last sync timestamp.
     - Store errors in `sync_error` field for diagnostics.

3. **API Endpoints & Admin Tools**
   - Update any route that fetches or displays `game_platform_*` fields to join against the new table.
   - Adjust admin dashboards / settings pages to reference new structure.
   - Add API endpoints for managing sync retries if needed (e.g., mark retry pending).

4. **RLS Policies**
   - Mirror `profiles` and `competitors` access rules so coaches/admins can read their own MetaCTF mappings while keeping cross-coach data restricted.

5. **Testing**
   - Update unit/integration tests to hit the new repository.
   - Expand Playwright coverage to ensure the onboarding flow still provisions MetaCTF users and records statuses accurately.
   - Add regression tests for duplicate-email handling against the new table.

### Rollout Checklist

1. Draft Supabase migration SQL (create table, indexes, policies).
2. Run migration in staging/pre-prod.
3. Enforce immutable search paths on all SECURITY DEFINER functions/triggers and rerun Supabase lint.
4. Port code paths to new repository.
5. Backfill and verify data via scripts.
6. Execute automated tests (unit, Playwright).
7. Remove legacy columns and clean up references.
8. Document new schema and ops procedures (e.g., how to replay failed syncs).

### Risk Mitigations

- Keep legacy columns until the new table proves stable; use feature flag or conditional reads during transition.
- Log all repository interactions to aid debugging post-cutover.
- Maintain manual recovery scripts (e.g., re-sync coach) before removing old logic.

### Search Path Hardening

- Audit `docs/database/db_schema_dump.sql` for SECURITY DEFINER functions/triggers (e.g., `public.handle_new_user`, job queue helpers) and ensure bodies reference schema-qualified objects (`public.*`).
- Add migrations that run `ALTER FUNCTION ... SET search_path = ''` (or recreate the function with the clause) so the Supabase lint 0011 warning clears.
- Include the same clause on any new functions introduced for the game platform tables to keep posture consistent.
- After deploying, rerun `supabase db lint` (or the dashboard advisor) to verify the warning no longer appears.

### ✅ Migration SQL Snippets

> Schema already exists in Supabase; column rename cleanup lives in `supabase/migrations/20251008_game_platform_synced_column_cleanup.sql` and the dedicated MetaCTF role enum is introduced in `supabase/migrations/20251008_game_platform_role_enum.sql`.

```sql
-- 1. Create enums for MetaCTF roles/status if not present
CREATE TYPE public.metactf_role AS ENUM ('coach', 'user');
CREATE TYPE public.metactf_sync_status AS ENUM ('pending', 'user_created', 'approved', 'denied', 'error');

-- 2. Create game_platform_profiles table
CREATE TABLE public.game_platform_profiles (
  id uuid DEFAULT extensions.uuid_generate_v4() PRIMARY KEY,
  coach_id uuid REFERENCES public.profiles(id) ON DELETE CASCADE,
  competitor_id uuid REFERENCES public.competitors(id) ON DELETE CASCADE,
  metactf_role public.metactf_role NOT NULL,
  synced_user_id text UNIQUE,
  metactf_user_id integer,
  metactf_username text,
  status public.metactf_sync_status DEFAULT 'pending'::public.metactf_sync_status,
  last_synced_at timestamptz,
  sync_error text,
  created_at timestamptz DEFAULT now() NOT NULL,
  updated_at timestamptz DEFAULT now() NOT NULL,
  CHECK ((coach_id IS NOT NULL AND competitor_id IS NULL) OR (coach_id IS NULL AND competitor_id IS NOT NULL))
);

-- If the table already exists and `metactf_role` is still using public.user_role, migrate it
ALTER TABLE public.game_platform_profiles
  ALTER COLUMN metactf_role TYPE public.metactf_role
  USING metactf_role::text::public.metactf_role;

ALTER TABLE public.game_platform_profiles
  ADD CONSTRAINT game_platform_profiles_coach_id_key UNIQUE (coach_id);

ALTER TABLE public.game_platform_profiles
  ADD CONSTRAINT game_platform_profiles_competitor_id_key UNIQUE (competitor_id);

-- RLS: allow coaches (or admins) to upsert their own mappings
CREATE POLICY gp_profiles_coach_insert ON public.game_platform_profiles
  FOR INSERT
  WITH CHECK (
    public.is_admin_user()
    OR (coach_id IS NOT NULL AND coach_id = auth.uid())
    OR (
      competitor_id IS NOT NULL
      AND competitor_id IN (
        SELECT id FROM public.competitors WHERE coach_id = auth.uid()
      )
    )
  );

CREATE POLICY gp_profiles_coach_update ON public.game_platform_profiles
  FOR UPDATE
  USING (
    public.is_admin_user()
    OR (coach_id IS NOT NULL AND coach_id = auth.uid())
    OR (
      competitor_id IS NOT NULL
      AND competitor_id IN (
        SELECT id FROM public.competitors WHERE coach_id = auth.uid()
      )
    )
  )
  WITH CHECK (
    public.is_admin_user()
    OR (coach_id IS NOT NULL AND coach_id = auth.uid())
    OR (
      competitor_id IS NOT NULL
      AND competitor_id IN (
        SELECT id FROM public.competitors WHERE coach_id = auth.uid()
      )
    )
  );

CREATE POLICY gp_teams_coach_insert ON public.game_platform_teams
  FOR INSERT
  WITH CHECK (
    public.is_admin_user()
    OR team_id IN (
      SELECT id FROM public.teams WHERE coach_id = auth.uid()
    )
  );

CREATE POLICY gp_teams_coach_update ON public.game_platform_teams
  FOR UPDATE
  USING (
    public.is_admin_user()
    OR team_id IN (
      SELECT id FROM public.teams WHERE coach_id = auth.uid()
    )
  )
  WITH CHECK (
    public.is_admin_user()
    OR team_id IN (
      SELECT id FROM public.teams WHERE coach_id = auth.uid()
    )
  );

-- 3. Create game_platform_teams table
CREATE TABLE public.game_platform_teams (
  id uuid DEFAULT extensions.uuid_generate_v4() PRIMARY KEY,
  team_id uuid UNIQUE REFERENCES public.teams(id) ON DELETE CASCADE,
  synced_team_id text,
  metactf_team_id integer,
  metactf_team_name text,
  status public.metactf_sync_status DEFAULT 'pending'::public.metactf_sync_status,
  last_synced_at timestamptz,
  sync_error text,
  created_at timestamptz DEFAULT now() NOT NULL,
  updated_at timestamptz DEFAULT now() NOT NULL
);

CREATE UNIQUE INDEX game_platform_teams_synced_idx ON public.game_platform_teams(synced_team_id) WHERE synced_team_id IS NOT NULL;

-- 4. Optional sync events
CREATE TABLE public.game_platform_sync_events (
  id uuid DEFAULT extensions.uuid_generate_v4() PRIMARY KEY,
  profile_id uuid REFERENCES public.game_platform_profiles(id) ON DELETE CASCADE,
  team_id uuid REFERENCES public.game_platform_teams(id) ON DELETE CASCADE,
  event_type text NOT NULL,
  request_payload jsonb,
  response_payload jsonb,
  status public.metactf_sync_status,
  created_at timestamptz DEFAULT now() NOT NULL
);

-- 5. RLS policies: allow coaches to read own mappings, admins to read all (pseudo)
ALTER TABLE public.game_platform_profiles ENABLE ROW LEVEL SECURITY;
CREATE POLICY gp_profiles_coach_read ON public.game_platform_profiles
  FOR SELECT USING (
    (coach_id IS NOT NULL AND coach_id = auth.uid()) OR
    (competitor_id IS NOT NULL AND competitor_id IN (SELECT id FROM public.competitors WHERE coach_id = auth.uid()))
  );

CREATE POLICY gp_profiles_admin_read ON public.game_platform_profiles
  FOR SELECT TO authenticated USING (public.is_admin_user());

ALTER TABLE public.game_platform_teams ENABLE ROW LEVEL SECURITY;
CREATE POLICY gp_teams_coach_read ON public.game_platform_teams
  FOR SELECT USING (
    team_id IN (
      SELECT id FROM public.teams WHERE coach_id = auth.uid()
    )
  );

CREATE POLICY gp_teams_admin_read ON public.game_platform_teams
  FOR SELECT TO authenticated USING (public.is_admin_user());

ALTER TABLE public.game_platform_sync_events ENABLE ROW LEVEL SECURITY;
CREATE POLICY gp_sync_events_admin_read ON public.game_platform_sync_events
  FOR SELECT TO authenticated USING (public.is_admin_user());

CREATE POLICY gp_sync_events_profile_link ON public.game_platform_sync_events
  FOR SELECT USING (
    profile_id IN (
      SELECT id FROM public.game_platform_profiles WHERE coach_id = auth.uid() OR competitor_id IN (
        SELECT id FROM public.competitors WHERE coach_id = auth.uid()
      )
    )
  );

-- Set immutable search path for existing functions/triggers
ALTER FUNCTION public.handle_new_user()
  SET search_path TO '';
```

> **Note:** Drop/alter policies once confirmed; adjust enum values to match final status names.

### Data Backfill & Cleanup

```sql
-- Backfill coach records into game_platform_profiles
INSERT INTO public.game_platform_profiles (
  coach_id,
  metactf_role,
  synced_user_id,
  status,
  last_synced_at
)
SELECT
  p.id,
  'coach',
  p.game_platform_user_id,
  (
    CASE
      WHEN p.game_platform_user_id IS NOT NULL THEN 'user_created'
      ELSE 'pending'
    END
  )::public.metactf_sync_status,
  p.game_platform_last_synced_at
FROM public.profiles p
LEFT JOIN public.game_platform_profiles gpp ON gpp.coach_id = p.id
WHERE p.game_platform_user_id IS NOT NULL
  AND gpp.id IS NULL;

-- Backfill competitor records
INSERT INTO public.game_platform_profiles (
  competitor_id,
  metactf_role,
  synced_user_id,
  status,
  last_synced_at,
  sync_error
)
SELECT
  c.id,
  'user',
  c.game_platform_id,
  (
    CASE
      WHEN c.game_platform_sync_error IS NOT NULL THEN 'error'
      WHEN c.game_platform_id IS NOT NULL THEN 'user_created'
      ELSE 'pending'
    END
  )::public.metactf_sync_status,
  c.game_platform_synced_at,
  c.game_platform_sync_error
FROM public.competitors c
LEFT JOIN public.game_platform_profiles gpp ON gpp.competitor_id = c.id
WHERE (c.game_platform_id IS NOT NULL OR c.game_platform_sync_error IS NOT NULL)
  AND gpp.id IS NULL;

-- Backfill team records
INSERT INTO public.game_platform_teams (
  team_id,
  synced_team_id,
  metactf_team_id,
  metactf_team_name,
  status,
  last_synced_at,
  sync_error
)
SELECT
  t.id,
  t.game_platform_id,
  NULL,
  t.name,
  (
    CASE
      WHEN t.game_platform_sync_error IS NOT NULL THEN 'error'
      WHEN t.game_platform_id IS NOT NULL THEN 'user_created'
      ELSE 'pending'
    END
  )::public.metactf_sync_status,
  t.game_platform_synced_at,
  t.game_platform_sync_error
FROM public.teams t
LEFT JOIN public.game_platform_teams gpt ON gpt.team_id = t.id
WHERE (t.game_platform_id IS NOT NULL OR t.game_platform_sync_error IS NOT NULL)
  AND gpt.id IS NULL;
```

1. Run the inserts above after deploying the new tables.
2. Validate counts (`SELECT COUNT(*)`) to confirm parity with the legacy columns.
3. Once the application is fully reading from the new tables, plan a follow-up migration to drop the legacy `game_platform_*` columns from `profiles`, `competitors`, and `teams`.
4. Rerun Supabase lint/advisor to ensure `search_path` warnings are resolved.

### Outstanding Follow-ups
- Apply search-path hardening migrations for SECURITY DEFINER functions and confirm `supabase db lint` passes.
- Execute the new schema migrations and backfill in staging, then production, with parity checks before removing legacy columns.
- Decide whether to implement the optional `game_platform_sync_events` audit table in a later phase.
- Update the operational runbook with the new table topology, backfill procedure, and failure recovery steps.

Legend: `[ ]` not started, `[x]` completed, `[=]` reviewed (no changes needed)

### Code Touch Checklist

**Core services & jobs**
- [x] `lib/integrations/game-platform/service.ts`[^service-details]
- [=] `lib/integrations/game-platform/client.ts`
- [x] `lib/integrations/game-platform/repository.ts`
- [=] `lib/jobs/types.ts`
- [=] `lib/jobs/handlers/gamePlatformSync.ts`
- [=] `lib/jobs/handlers/gamePlatformTotalsSweep.ts`

**API routes**
- [=] `app/api/game-platform/competitors/[id]/route.ts`
- [=] `app/api/game-platform/teams/[id]/sync/route.ts`
- [x] `app/api/game-platform/report-card/[competitorId]/route.ts`
- [=] `app/api/game-platform/report-card/[competitorId]/pdf/route.ts`
- [=] `app/api/internal/sync/route.ts`
- [=] `app/api/admin/jobs/trigger-sync/route.ts`
- [=] `app/api/admin/jobs/trigger-totals-sweep/route.ts`
- [x] `app/api/coaches/register/route.ts`
- [x] `app/api/competitors/create/route.ts`
- [=] `app/api/competitors/[id]/update/route.ts`
- [=] `app/api/competitors/[id]/toggle-active/route.ts`
- [=] `app/api/competitors/profile/[token]/update/route.ts`
- [=] `app/api/competitors/profile/[token]/send-participation/route.ts`
- [=] `app/api/competitors/maintenance/update-statuses/route.ts`
- [=] `app/api/competitors/bulk-import/route.ts`
- [=] `app/api/competitors/[id]/disclosure-log/route.ts`
- [=] `app/api/competitors/[id]/regenerate-link/route.ts`
- [x] `app/api/teams/[id]/members/add/route.ts`
- [=] `app/api/teams/[id]/members/[competitor_id]/route.ts`
- [=] `app/api/teams/[id]/upload-image/route.ts`
- [=] `app/api/admin/context/route.ts`
- [x] `app/api/game-platform/dashboard/route.ts`
- [x] `app/api/competitors/route.ts`
- [x] `app/api/competitors/paged/route.ts`

**Client-side pages/components**
- [x] `app/dashboard/page.tsx`
- [=] `app/dashboard/teams/page.tsx`
- [=] `app/dashboard/disclosures/page.tsx`
- [=] `app/dashboard/releases/page.tsx`
- [=] `app/dashboard/bulk-import/page.tsx`
- [=] `components/dashboard/competitor-form.tsx`
- [=] `components/dashboard/competitor-edit-form.tsx`
- [=] `components/dashboard/coach-assist-tool.tsx`
- [=] `components/dashboard/admin-tools-link.tsx`
- [x] `components/dashboard/competitor-columns.tsx`
- [=] `components/dashboard/admin/create-job-dialog.tsx`
- [=] `components/dashboard/admin-tools/jobs/page.tsx`
- [=] `app/update-profile/[token]/page.tsx`

**Utilities / guards**
- [=] `components/SingleSessionGuard.tsx`
- [=] `middleware.ts`
- [=] `lib/utils/competitor-status.ts`
- [=] `lib/audit/audit-logger.ts`

**Scripts / Tests**
- [=] `tests/e2e/email-uniqueness.spec.ts`
- [=] `tests/meta-production/*.sh` (verify scripts)
- [x] `tests/e2e/game-platform-routes.spec.ts` (new coverage)
- [=] Any other Playwright or Vitest suites referencing game platform fields

**Documentation / SQL**
- [x] `docs/game-platform/integration-refactoring.md`
- [ ] `docs/game-platform/MetaCTF_api_definition.json`
- [ ] `docs/database/db_schema_dump.sql` & `db_data_dump.sql` (once migrations applied)
- [ ] `scripts/fix_monday_sync_trigger.sql`
- [ ] `scripts/*.sql` touching `game_platform_*`

**Cleanup**
- [ ] Remove legacy columns from `profiles`, `competitors`, `teams`
- [ ] Update Supabase views/triggers relying on old columns
- [ ] Remove obsolete code paths after verifying new structure

[^service-details]: `service.ts` now reads/writes through `game_platform_profiles` and `game_platform_teams`; it records MetaCTF status/IDs on coach onboarding, updates competitor mappings on success/error, and persists team sync metadata while keeping legacy columns in sync.
